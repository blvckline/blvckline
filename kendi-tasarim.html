<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <title>Kendi Tasarımını Oluştur</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body { background:#000; color:#fff; font-family:Arial,sans-serif; text-align:center; padding:20px; }
    select,input[type="file"] { margin:10px; padding:8px; font-size:16px; }
    #canvasWrapper {
      position:relative;
      margin:20px auto;
      background:#222;
      width:300px; height:400px;
      border:2px dashed #25d366;
      overflow:hidden;
      touch-action:none;
    }
    .product { width:100%; height:100%; object-fit:contain; }
    #uploadedImage {
      position:absolute;
      top:50%; left:50%;
      transform:translate(-50%,-50%);
      max-width:100px; max-height:100px;
    }
    .button {
      background:#25d366;
      color:#000;
      padding:10px 20px;
      border:none;
      border-radius:8px;
      font-weight:bold;
      cursor:pointer;
      margin-top:20px;
    }
  </style>
</head>
<body>
  <h1>Kendi Tasarımını Oluştur</h1>

  <select id="productType">
    <option value="tisort">Tişört</option>
    <option value="crop">Crop Top</option>
    <option value="sweat">Sweatshirt</option>
  </select>

  <select id="productColor">
    <option value="siyah">Siyah</option>
    <option value="beyaz">Beyaz</option>
    <option value="gri">Gri</option>
  </select>

  <input type="file" id="imageUpload" accept="image/*">

  <div id="canvasWrapper">
    <img id="productImage" class="product" src="">
    <img id="uploadedImage" src="" style="display:none;">
  </div>

  <button class="button" onclick="gonderFatura()">Tasarımı Faturaya Gönder</button>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script>
    const productImage  = document.getElementById("productImage");
    const uploadedImage = document.getElementById("uploadedImage");
    const wrapper       = document.getElementById("canvasWrapper");

    // Galeriden gelen ?gorsel=
    const params = new URLSearchParams(location.search);
    const g = params.get("gorsel");
    if (g) {
      uploadedImage.src = decodeURIComponent(g);
      uploadedImage.style.display = "block";
    }

    // Ürün resmi güncelle
    function updateProduct() {
      const t = document.getElementById("productType").value;
      const c = document.getElementById("productColor").value;
      productImage.src = `${t}_${c}.png`;
    }
    document.getElementById("productType").addEventListener("change", updateProduct);
    document.getElementById("productColor").addEventListener("change", updateProduct);
    updateProduct();

    // Dosya yükleme
    document.getElementById("imageUpload").addEventListener("change", e => {
      const f = e.target.files[0];
      if (!f) return;
      const r = new FileReader();
      r.onload = ev => {
        uploadedImage.src = ev.target.result;
        uploadedImage.style.display = "block";
      };
      r.readAsDataURL(f);
    });

    // Drag & Pinch Zoom
    let dragging=false, pinching=false,
        ox=0, oy=0, sd=0, sw=0;

    function dist(a,b){
      return Math.hypot(a.pageX-b.pageX,a.pageY-b.pageY);
    }

    function start(e){
      e.preventDefault();
      const touches = e.touches||[e];
      if (touches.length===1){
        dragging=true;
        ox = touches[0].pageX - uploadedImage.offsetLeft;
        oy = touches[0].pageY - uploadedImage.offsetTop;
      }
      if (touches.length===2){
        pinching=true;
        sd = dist(touches[0],touches[1]);
        sw = uploadedImage.offsetWidth;
      }
    }
    uploadedImage.addEventListener("mousedown", start);
    uploadedImage.addEventListener("touchstart", start);

    function move(e){
      const touches = e.touches||[e];
      if (dragging && touches.length===1){
        e.preventDefault();
        uploadedImage.style.left = touches[0].pageX - wrapper.offsetLeft - ox + "px";
        uploadedImage.style.top  = touches[0].pageY - wrapper.offsetTop - oy + "px";
      }
      if (pinching && touches.length===2){
        e.preventDefault();
        const cd = dist(touches[0],touches[1]);
        const scale = cd/sd;
        uploadedImage.style.width = sw*scale+"px";
        uploadedImage.style.height= "auto";
      }
    }
    document.addEventListener("mousemove", move);
    document.addEventListener("touchmove", move, {passive:false});

    function end(){
      dragging=false; pinching=false;
    }
    document.addEventListener("mouseup", end);
    document.addEventListener("touchend", end);
    document.addEventListener("touchcancel", end);

    // Mouse wheel zoom
    uploadedImage.addEventListener("wheel", e => {
      e.preventDefault();
      const s = e.deltaY<0?1.1:0.9;
      uploadedImage.style.width = uploadedImage.offsetWidth*s+"px";
      uploadedImage.style.height= "auto";
    });

    // Faturaya gönder
    function gonderFatura(){
      html2canvas(wrapper).then(canvas=>{
        const b64 = canvas.toDataURL("image/png");
        const t = document.getElementById("productType").value;
        const r = document.getElementById("productColor").value;
        window.open(`fatura.html?tasarim=${encodeURIComponent(b64)}&tip=${t}&renk=${r}`,'_blank');
      });
    }
  </script>
</body>
</html>
