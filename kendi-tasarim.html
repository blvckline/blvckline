<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <title>Kendi Tasarımını Oluştur</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body {
      background: #000;
      color: #fff;
      font-family: Arial, sans-serif;
      text-align: center;
      padding: 20px;
      overflow-x: hidden;
    }
    select, input[type="file"], input[type="text"], select.font-select, select.color-select {
      margin: 10px;
      padding: 8px;
      font-size: 16px;
    }
    #canvasWrapper {
      position: relative;
      margin: 20px auto;
      background: #222;
      width: 300px;
      height: 400px;
      border: 2px dashed #25d366;
      overflow: hidden;
      touch-action: none;
    }
    .product {
      width: 100%;
      height: 100%;
      object-fit: contain;
      user-select: none;
      pointer-events: none;
    }
    #uploadedImage, .overlayText {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      max-width: 150px;
      max-height: 150px;
      cursor: move;
    }
    .button {
      background-color: #25d366;
      color: #000;
      padding: 10px 20px;
      border: none;
      border-radius: 8px;
      font-weight: bold;
      cursor: pointer;
      margin-top: 20px;
    }
  </style>
</head>
<body>
  <h1>Kendi Tasarımını Oluştur</h1>

  <!-- Ürün ve renk seçimi -->
  <select id="productType">
    <option value="tisort">Tişört</option>
    <option value="crop">Crop Top</option>
    <option value="sweat">Sweatshirt</option>
  </select>

  <select id="productColor">
    <option value="siyah">Siyah</option>
    <option value="beyaz">Beyaz</option>
    <option value="gri">Gri</option>
  </select>

  <!-- Resim yükleme -->
  <input type="file" id="imageUpload" accept="image/*">

  <!-- Yazı ekleme -->
  <br>
  <input type="text" id="textInput" placeholder="Yazınızı girin">
  <select id="fontSelect" class="font-select">
    <option value="Arial">Arial</option>
    <option value="Roboto">Roboto</option>
    <option value="Courier New">Courier New</option>
  </select>
  <input type="color" id="textColor" value="#ff0000" class="color-select">
  <button class="button" id="addTextBtn">Metni Ekle</button>

  <!-- Tasarım alanı -->
  <div id="canvasWrapper">
    <img id="productImage" class="product" src="tisort_siyah.png" alt="Ürün">
    <!-- Kullanıcının yüklediği resim -->
    <img id="uploadedImage" style="display:none;">
    <!-- Dinamik eklenen metin -->
  </div>

  <button class="button" id="sendInvoiceBtn">Tasarımı Faturaya Gönder</button>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script>
    const productImage   = document.getElementById("productImage");
    const uploadedImage  = document.getElementById("uploadedImage");
    const canvasWrapper  = document.getElementById("canvasWrapper");
    const addTextBtn     = document.getElementById("addTextBtn");
    const sendInvoiceBtn = document.getElementById("sendInvoiceBtn");

    // Ürün / renk güncelleme
    function updateProduct(){
      const type  = document.getElementById("productType").value;
      const color = document.getElementById("productColor").value;
      productImage.src = `${type}_${color}.png`;
    }
    document.getElementById("productType").addEventListener("change", updateProduct);
    document.getElementById("productColor").addEventListener("change", updateProduct);

    // Resim yükleme ve sürükle/büyült
    document.getElementById("imageUpload").addEventListener("change", e=>{
      const file = e.target.files[0];
      if(!file) return;
      const reader = new FileReader();
      reader.onload = evt=>{
        uploadedImage.src = evt.target.result;
        uploadedImage.style.display = 'block';
      };
      reader.readAsDataURL(file);
    });

    let dragTarget=null, offsetX=0, offsetY=0;
    function makeDraggable(el){
      el.addEventListener("pointerdown", e=>{
        dragTarget = el;
        offsetX = e.clientX - el.getBoundingClientRect().left;
        offsetY = e.clientY - el.getBoundingClientRect().top;
        el.setPointerCapture(e.pointerId);
      });
      el.addEventListener("pointermove", e=>{
        if(dragTarget===el){
          const rect = canvasWrapper.getBoundingClientRect();
          let x = e.clientX - rect.left - offsetX;
          let y = e.clientY - rect.top  - offsetY;
          // sınır kontrolü (opsiyonel)
          el.style.left = `${x}px`;
          el.style.top  = `${y}px`;
        }
      });
      el.addEventListener("pointerup",   ()=> dragTarget=null);
      el.addEventListener("pointercancel",()=> dragTarget=null);
      // zoom
      el.addEventListener("wheel", e=>{
        if(!dragTarget) return;
        e.preventDefault();
        let scale = e.deltaY<0 ? 1.1 : 0.9;
        el.style.width  = el.offsetWidth * scale + 'px';
        el.style.height = 'auto';
      });
    }
    makeDraggable(uploadedImage);

    // Metin ekleme
    addTextBtn.addEventListener("click", ()=>{
      const txt = document.getElementById("textInput").value.trim();
      if(!txt) return;
      const font  = document.getElementById("fontSelect").value;
      const color = document.getElementById("textColor").value;
      const span  = document.createElement("span");
      span.textContent = txt;
      span.className = "overlayText";
      span.style.color       = color;
      span.style.fontFamily  = font;
      span.style.fontSize    = '24px';
      span.style.pointerEvents = 'all';
      canvasWrapper.appendChild(span);
      makeDraggable(span);
    });

    // Faturaya gönder
    sendInvoiceBtn.addEventListener("click", ()=>{
      html2canvas(canvasWrapper).then(canvas=>{
        const dataURL = canvas.toDataURL("image/png");
        // tasarim parametresiyle fatura.html'e yönlendir
        window.open(`fatura.html?tasarim=${encodeURIComponent(dataURL)}&tip=${document.getElementById("productType").value}&renk=${document.getElementById("productColor").value}`, '_blank');
      });
    });
  </script>
</body>
</html>
